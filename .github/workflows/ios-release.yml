name: iOS Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'testflight'
        type: choice
        options:
        - testflight
        - appstore
      build_number:
        description: 'Build number (optional, will auto-increment if not provided)'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.24.0'
  XCODE_VERSION: '15.0'

jobs:
  build-and-deploy:
    name: Build and Deploy iOS
    runs-on: macos-latest
    environment: production
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        cache: true
        
    - name: Get Flutter dependencies
      run: flutter pub get
      
    - name: Run tests
      run: flutter test
      
    - name: Setup iOS certificates and provisioning profiles
      env:
        IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        
        # Import certificate and provisioning profile from secrets
        echo -n "$IOS_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
        echo -n "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH
        
        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        
        # Import certificate to keychain
        security import $CERTIFICATE_PATH -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH
        
        # Apply provisioning profile
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles
        
    - name: Update version and build number
      run: |
        # Extract version from git tag or use default
        if [[ "${{ github.event_name }}" == "release" ]]; then
          VERSION="${{ github.event.release.tag_name }}"
          VERSION=${VERSION#v}  # Remove 'v' prefix if present
        else
          VERSION="1.0.0"
        fi
        
        # Use provided build number or auto-increment
        if [[ -n "${{ github.event.inputs.build_number }}" ]]; then
          BUILD_NUMBER="${{ github.event.inputs.build_number }}"
        else
          BUILD_NUMBER="${{ github.run_number }}"
        fi
        
        # Update pubspec.yaml
        sed -i '' "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
        echo "Updated version to: $VERSION+$BUILD_NUMBER"
        
        # Update iOS version in Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $VERSION" ios/Runner/Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" ios/Runner/Info.plist
        
    - name: Build iOS app
      run: |
        flutter build ios --release --no-codesign
        
    - name: Build and archive iOS app
      run: |
        cd ios
        
        # Build archive
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath $RUNNER_TEMP/nutrisync.xcarchive \
          archive
          
    - name: Export IPA
      env:
        EXPORT_METHOD: ${{ github.event.inputs.environment == 'appstore' && 'app-store' || 'ad-hoc' }}
      run: |
        # Create export options plist
        cat > $RUNNER_TEMP/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>method</key>
          <string>$EXPORT_METHOD</string>
          <key>teamID</key>
          <string>${{ secrets.IOS_TEAM_ID }}</string>
          <key>uploadBitcode</key>
          <false/>
          <key>uploadSymbols</key>
          <true/>
          <key>compileBitcode</key>
          <false/>
        </dict>
        </plist>
        EOF
        
        # Export IPA
        xcodebuild -exportArchive \
          -archivePath $RUNNER_TEMP/nutrisync.xcarchive \
          -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
          -exportPath $RUNNER_TEMP/build
          
    - name: Upload to TestFlight
      if: github.event.inputs.environment != 'appstore'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      run: |
        # Upload to TestFlight
        xcrun altool --upload-app \
          --type ios \
          --file "$RUNNER_TEMP/build/NutriSync.ipa" \
          --username "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --asc-provider "$IOS_TEAM_ID"
          
    - name: Upload to App Store
      if: github.event.inputs.environment == 'appstore'
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      run: |
        # Upload to App Store for review
        xcrun altool --upload-app \
          --type ios \
          --file "$RUNNER_TEMP/build/NutriSync.ipa" \
          --username "$APPLE_ID" \
          --password "$APPLE_APP_SPECIFIC_PASSWORD" \
          --asc-provider "$IOS_TEAM_ID"
          
    - name: Upload IPA to artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ios-ipa-${{ github.run_number }}
        path: ${{ runner.temp }}/build/NutriSync.ipa
        retention-days: 30
        
    - name: Create GitHub Release Assets
      if: github.event_name == 'release'
      run: |
        # Upload IPA to GitHub Release
        gh release upload ${{ github.event.release.tag_name }} \
          "$RUNNER_TEMP/build/NutriSync.ipa" \
          --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Clean up keychain and provisioning profile
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm -f ~/Library/MobileDevice/Provisioning\ Profiles/*.mobileprovision || true
        
    - name: Notify success
      if: success()
      uses: 8398a7/action-slack@v3
      with:
        status: success
        text: |
          üçé iOS app successfully deployed!
          Environment: ${{ github.event.inputs.environment || 'testflight' }}
          Version: ${{ github.event.release.tag_name || github.run_number }}
          Platform: iOS
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Notify failure
      if: failure()
      uses: 8398a7/action-slack@v3
      with:
        status: failure
        text: |
          ‚ùå iOS deployment failed!
          Check the logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}